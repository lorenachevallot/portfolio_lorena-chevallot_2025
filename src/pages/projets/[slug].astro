---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import SectionTitle from "../../components/projet/SectionTitle.astro";
import StrategieCard from "../../components/projet/StrategieCard.astro";
import CouleursGrid from "../../components/projet/CouleursGrid.astro";
import {
    getProjetBySlug,
    parseTypographies,
    getLogicielsDetails,
    getImageUrl,
    formatTypoName,
    getTypoSize,
} from "../../lib/pockebase.mjs";
import type { ProjetRecord, LogicielRecord } from "../../lib/types";

const { slug } = Astro.params;
const projet = (await getProjetBySlug(slug!)) as ProjetRecord;

if (!projet) {
    console.error("Projet non trouvé pour le slug:", slug);
    return Astro.redirect("/");
}

// Parser les typographies
const typoArray = parseTypographies(projet);

// Déterminer le nombre de blocs de couleurs
const hasCouleursOriginelles = Boolean(projet?.couleurs_originelles);
const hasCouleurs = Boolean(projet?.couleurs);
const nbBlocsCouleurs = (hasCouleursOriginelles ? 1 : 0) + (hasCouleurs ? 1 : 0);

// Récupérer les détails des logiciels
const logicielsDetails = (await getLogicielsDetails(projet)) as LogicielRecord[];

const typoFormatted = projet.typo_nom ? formatTypoName(projet.typo_nom) : "";
---

<Layout title={`${projet.nom} - Loréna Chevallot`}>
    {projet.ellipse && (
                            <div
                                class="absolute w-dvw h-dvw rounded-full blur-3xl opacity-80 z-0 -top-[50dvh] left-1/2 -translate-x-1/2 -translate-y-1/2"
                                style={`background: radial-gradient(circle,  ${projet.ellipse} 0%, transparent 70%);`}
                            />
                        )}
    <section class="bg-black text-white pt-24 lg:pt-24 pb-0 px-4 lg:px-16 h-fit">
        <div class="max-w-7xl mx-auto">
            <div class="mb-4 lg:mb-8">
                
                <a
                    href="/#projets"
                    class="inline-flex items-center gap-2 text-gray-400 hover:text-orange-500 transition-colors mb-4 lg:mb-6"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Retour aux projets
                </a>

                <div class="flex flex-col items-center gap-2 lg:gap-4 mb-2 lg:mb-4">
                    {
                        projet.logo && (
                            <img
                                src={getImageUrl(
                                    projet.collectionId,
                                    projet.id,
                                    projet.logo,
                                )}
                                alt={projet.nom}
                                class="w-48 lg:w-72 h-48 lg:h-72 object-contain drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] relative z-30"
                            />
                        )
                    }
                    <h1
                        class="relative z-20 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] text-3xl lg:text-5xl"
                        style=`
                    @import url('https://fonts.googleapis.com/css2?family=${typoFormatted}:wght@100..900&display=swap');
                    font-family: '${projet.typo_nom}', sans-serif !important;
                    text-transform: none !important;`
                    >
                        {projet.nom}
                    </h1>
                </div>

                {
                    projet.sloggan && (
                        <p class="text-lg lg:text-2xl text-white-400 text-center relative z-20">
                            {projet.sloggan}
                        </p>
                    )
                }
            </div>

            <!-- Section 1: Prévisualisation -->
            {
                projet.previsualisation && (
                    <div class="mb-16 lg:mb-64 relative flex justify-center items-center">
                        {projet.ellipse && (
                            <div
                                class="absolute w-[400px] lg:w-[1200px] h-[400px] lg:h-[1200px] rounded-full blur-3xl opacity-80 z-0"
                                style={`background: radial-gradient(circle, ${projet.ellipse} 0%, transparent 70%);`}
                            />
                        )}
                        <div class="rounded-2xl overflow-hidden relative z-10">
                            <img
                                src={getImageUrl(
                                    projet.collectionId,
                                    projet.id,
                                    projet.previsualisation,
                                )}
                                alt={projet.nom}
                                class="w-[90vw] lg:w-[70vw] mx-auto h-auto object-cover"
                            />
                        </div>
                    </div>
                )
            }

            {
                logicielsDetails.length > 0 && (
                    <div class="mb-16 lg:mb-64">
                        <SectionTitle title="Logiciels utilisés" />
                        <div class="flex flex-wrap gap-3 lg:gap-4 justify-between">
                            {logicielsDetails.map(
                                (logiciel: LogicielRecord) => (
                                    <div class="flex flex-col items-center gap-1 lg:gap-2">
                                        <img
                                            src={getImageUrl(
                                                logiciel.collectionId,
                                                logiciel.id,
                                                logiciel.logo,
                                            )}
                                            alt={logiciel.nom}
                                            class="h-12 lg:h-full w-auto object-contain"
                                        />
                                        <span class="text-xs lg:text-sm text-gray-400">
                                            {logiciel.nom}
                                        </span>
                                    </div>
                                ),
                            )}
                        </div>
                    </div>
                )
            }

            <!-- Section 3: Contexte -->
            {
                projet.contexte && (
                    <div class="mb-16 lg:mb-64 relative">
                        <div
                            class="bg-zinc-900/50 backdrop-blur-sm p-6 lg:p-12 rounded-2xl border-2 border-white shadow-[0_0_25px_rgba(255,255,255,0.8)]"
                            style={
                                projet.contour_contexte
                                    ? `box-shadow: 0 0 25px rgba(255,255,255,0.8), 0 0 50px ${projet.contour_contexte}, 0 0 100px ${projet.contour_contexte};`
                                    : ""
                            }
                        >
                            <h2
                                class="font-bold mb-4 lg:mb-6"
                                style="font-family: 'Raleway', sans-serif !important; font-weight: 700 !important; font-size: 1.875rem !important;"
                            >
                                Contexte, enjeux et objectifs
                            </h2>
                            <p class="text-gray-300 leading-relaxed text-base lg:text-lg lg:max-w-[70%]">
                                {projet.contexte}
                            </p>
                        </div>
                        {projet.image_contexte && (
                            <div class="absolute top-1/2 -right-16 transform -translate-y-1/2 w-2/5 hidden lg:block">
                                <img
                                    src={getImageUrl(
                                        projet.collectionId,
                                        projet.id,
                                        projet.image_contexte,
                                    )}
                                    alt="Image contexte"
                                    class="w-full h-auto rounded-lg"
                                />
                            </div>
                        )}
                    </div>
                )
            }

            <!-- Section 4: Stratégie -->
            {
                (projet.titre_strat_1 ||
                    projet.titre_strat_2 ||
                    projet.titre_strat_3) && (
                    <div class="mb-16 lg:mb-64">
                        <SectionTitle title="Stratégie de communication" />
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                            {projet.titre_strat_1 && (
                                <StrategieCard
                                    titre={projet.titre_strat_1}
                                    texte={projet.texte_strat_1}
                                    logo={projet.logo_strat_1}
                                    getImageUrl={getImageUrl}
                                    collectionId={projet.collectionId}
                                    recordId={projet.id}
                                />
                            )}
                            {projet.titre_strat_2 && (
                                <StrategieCard
                                    titre={projet.titre_strat_2}
                                    texte={projet.texte_strat_2}
                                    logo={projet.logo_strat_2}
                                    getImageUrl={getImageUrl}
                                    collectionId={projet.collectionId}
                                    recordId={projet.id}
                                />
                            )}
                            {projet.titre_strat_3 && (
                                <StrategieCard
                                    titre={projet.titre_strat_3}
                                    texte={projet.texte_strat_3}
                                    logo={projet.logo_strat_3}
                                    getImageUrl={getImageUrl}
                                    collectionId={projet.collectionId}
                                    recordId={projet.id}
                                />
                            )}
                        </div>
                    </div>
                )
            }

            <!-- Section 5: Logo -->
            {
                (projet.texte_logo ||
                    projet.recherche_graphique ||
                    projet.logo) && (
                    <div class="mb-16 lg:mb-64">
                        <SectionTitle title="Logo" withLine={false} />
                        <div
                            class="h-0.5 bg-white mb-4 lg:mb-6 w-full"
                            style="box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.6);"
                        />
                        {projet.texte_logo && (
                            <p class="text-gray-300 leading-relaxed mb-6 lg:mb-12">
                                {projet.texte_logo}
                            </p>
                        )}
                        <div class="flex flex-col lg:flex-row lg:gap-32 items-center lg:items-start justify-center lg:justify-start gap-6">
                            <div class="flex flex-col gap-6 lg:gap-0">
                                {projet.ancien_logo && (
                                    <div>
                                    <SectionTitle
                                        title="Ancien logo"
                                        size="medium"
                                        withLine={false}
                                    />
                                    <div class="flex justify-center lg:justify-start">
                                        <div class="bg-zinc-900/50 backdrop-blur-sm p-4 lg:p-8 rounded-2xl border border-white shadow-[0_0_15px_rgba(255,255,255,0.5)] flex items-center justify-center h-40 lg:h-[40dvh] aspect-square">
                                            <img
                                                src={getImageUrl(
                                                    projet.collectionId,
                                                    projet.id,
                                                    projet.ancien_logo,
                                                )}
                                                alt="Ancien logo"
                                                class="w-full h-full object-contain"
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                            </div>
                            {projet.recherche_graphique &&
                                projet.recherche_graphique.length > 0 && (
                                    <div class="flex flex-col">
                                        <SectionTitle
                                            title="Recherche graphique"
                                            size="medium"
                                            withLine={false}
                                        />
                                        <div class="flex justify-center lg:justify-start">
                                            <div
                                                class={`grid ${projet.recherche_graphique.length === 4 ? "grid-cols-2 grid-rows-2" : "grid-cols-2 lg:grid-cols-3 lg:grid-rows-2"} gap-x-3 lg:gap-x-6 gap-y-3 lg:gap-y-6 w-fit h-40 lg:h-[40dvh]`}
                                            >
                                                {projet.recherche_graphique.map(
                                                    (image: string) => (
                                                        <div class="bg-zinc-900/50 backdrop-blur-sm p-2 lg:p-3 rounded-xl border border-white shadow-[0_0_15px_rgba(255,255,255,0.5)] flex items-center justify-center aspect-square">
                                                            <img
                                                                src={getImageUrl(
                                                                    projet.collectionId,
                                                                    projet.id,
                                                                    image,
                                                                )}
                                                                alt="Recherche graphique"
                                                                class="w-full h-full object-contain"
                                                            />
                                                        </div>
                                                    ),
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            {projet.logo && (
                                <div>
                                    <SectionTitle
                                        title="Logo final"
                                        size="medium"
                                        withLine={false}
                                    />
                                    <div class="flex justify-center lg:justify-start">
                                        <div class="bg-zinc-900/50 backdrop-blur-sm p-4 lg:p-8 rounded-2xl border border-white shadow-[0_0_15px_rgba(255,255,255,0.5)] flex items-center justify-center h-40 lg:h-[40dvh] aspect-square">
                                            <img
                                                src={getImageUrl(
                                                    projet.collectionId,
                                                    projet.id,
                                                    projet.logo,
                                                )}
                                                alt="Logo final"
                                                class="w-full h-full object-contain"
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                            {projet.deuxieme_logo_final && (
                                <div>
                                    <div class="mb-2 lg:mb-4 h-4 lg:h-8"></div>
                                    <div class="flex justify-center lg:justify-start">
                                        <div class="bg-zinc-900/50 backdrop-blur-sm p-4 lg:p-8 rounded-2xl border border-white shadow-[0_0_15px_rgba(255,255,255,0.5)] flex items-center justify-center w-auto h-32 lg:h-80">
                                            <img
                                                src={getImageUrl(
                                                    projet.collectionId,
                                                    projet.id,
                                                    projet.deuxieme_logo_final,
                                                )}
                                                alt="Logo final 2"
                                                class="h-full w-auto object-contain"
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )
            }

            <!-- Section 6: Couleurs et Typographies -->
            {
                (projet.couleurs_originelles || projet.couleurs) && (
                    <div class="mb-16 lg:mb-64">
                        <SectionTitle title="Couleurs" withLine={false} />
                        <div
                            class="h-0.5 bg-white mb-4 lg:mb-6 w-full"
                            style="box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.6);"
                        />
                        {projet.texte_couleurs && (
                            <p class="text-gray-300 mb-4 lg:mb-6 leading-relaxed">
                                {projet.texte_couleurs}
                            </p>
                        )}

                        {/* Si 2 blocs de couleurs : grille 2 colonnes puis typo en dessous */}
                        {nbBlocsCouleurs === 2 ? (
                            <>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-8 mb-6 lg:mb-8">
                                    {projet.couleurs_originelles && (
                                        <CouleursGrid
                                            couleurs={
                                                projet.couleurs_originelles
                                            }
                                            titre="Couleurs originelles"
                                        />
                                    )}
                                    {projet.couleurs && (
                                        <CouleursGrid
                                            couleurs={projet.couleurs}
                                            titre="Couleurs finales"
                                        />
                                    )}
                                </div>
                                {typoArray.length > 0 && (
                                    <div class="bg-zinc-900/50 backdrop-blur-sm p-6 lg:p-8 rounded-2xl border border-zinc-800">
                                        <SectionTitle
                                            title="Typographies"
                                            size="medium"
                                            withLine={false}
                                        />
                                        <div class="space-y-3 lg:space-y-4">
                                            {typoArray.map(
                                                ({ name, fontFamily }) => (
                                                    <div class="border-b border-zinc-700 pb-3 lg:pb-4 last:border-b-0">
                                                        <p class="text-xs lg:text-sm text-gray-400 mb-1 lg:mb-2">
                                                            {formatTypoName(
                                                                name,
                                                            )}
                                                        </p>
                                                        <p
                                                            class={`${getTypoSize(name)} font-bold`}
                                                            style={`font-family: '${fontFamily}', sans-serif !important`}
                                                        >
                                                            {fontFamily}
                                                        </p>
                                                    </div>
                                                ),
                                            )}
                                        </div>
                                    </div>
                                )}
                            </>
                        ) : (
                            /* Si 1 seul bloc : couleur et typo côte à côte sans que couleur s'adapte */
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-8 items-start">
                                <div>
                                    {projet.couleurs_originelles && (
                                        <CouleursGrid
                                            couleurs={
                                                projet.couleurs_originelles
                                            }
                                            titre="Couleurs originelles"
                                        />
                                    )}
                                    {projet.couleurs && (
                                        <CouleursGrid
                                            couleurs={projet.couleurs}
                                            titre="Couleurs finales"
                                        />
                                    )}
                                </div>
                                {typoArray.length > 0 && (
                                    <div class="bg-zinc-900/50 backdrop-blur-sm p-6 lg:p-8 rounded-2xl border border-zinc-800">
                                        <SectionTitle
                                            title="Typographies"
                                            size="medium"
                                            withLine={false}
                                        />
                                        <div class="space-y-3 lg:space-y-4">
                                            {typoArray.map(
                                                ({ name, fontFamily }) => (
                                                    <div class="border-b border-zinc-700 pb-3 lg:pb-4 last:border-b-0">
                                                        <p class="text-xs lg:text-sm text-gray-400 mb-1 lg:mb-2">
                                                            {formatTypoName(
                                                                name,
                                                            )}
                                                        </p>
                                                        <p
                                                            class={`${getTypoSize(name)} font-bold`}
                                                            style={`font-family: '${fontFamily}', sans-serif !important`}
                                                        >
                                                            {fontFamily}
                                                        </p>
                                                    </div>
                                                ),
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )
            }

            <!-- Section 8: Moodboard -->
            {
                projet.moodboard && (
                    <div class="mb-16 lg:mb-48">
                        <SectionTitle title="Moodboard" withLine={false} />
                        <div
                            class="h-0.5 bg-white mb-4 lg:mb-6 w-full"
                            style="box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.6);"
                        />
                        <div class="rounded-2xl overflow-hidden shadow-2xl max-w-4xl mx-auto">
                            <img
                                src={getImageUrl(
                                    projet.collectionId,
                                    projet.id,
                                    projet.moodboard,
                                )}
                                alt="Moodboard"
                                class="w-full h-auto object-cover"
                            />
                        </div>
                    </div>
                )
            }

            <!-- Section 9: Livrable -->
            {
                (projet.livrable_texte || projet.livrable_image) && (
                    <div class="mb-16 lg:mb-64">
                        <SectionTitle title="Livrable" withLine={false} />
                        <div
                            class="h-0.5 bg-white mb-4 lg:mb-6 w-full"
                            style="box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.6);"
                        />
                        {projet.livrable_texte && (
                            <p class="text-gray-300 leading-relaxed mb-4 lg:mb-6">
                                {projet.livrable_texte}
                            </p>
                        )}
                        {projet.livrable_image && (
                            <img
                                src={getImageUrl(
                                    projet.collectionId,
                                    projet.id,
                                    projet.livrable_image,
                                )}
                                alt="Livrable"
                                class="w-full h-auto rounded-lg"
                            />
                        )}
                    </div>
                )
            }
        </div>
    </section>

    <!-- Section 10: Mockups -->
    {
        projet.mockups && projet.mockups.length > 0 && (
            <div class="w-full bg-black">
                <div class="flex flex-col">
                    {projet.mockups.map((mockup: string) => (
                        <div class="w-full">
                            <img
                                src={getImageUrl(
                                    projet.collectionId,
                                    projet.id,
                                    mockup,
                                )}
                                alt="Mockup"
                                class="w-full h-auto object-cover"
                            />
                        </div>
                    ))}
                </div>
            </div>
        )
    }
</Layout>

<style is:inline>
    {typoArray.map(({ fontFamily }) => {
        const formattedFont = fontFamily.replace(/\s+/g, '+');
        return `@import url('https://fonts.googleapis.com/css2?family=${formattedFont}:wght@100..900&display=swap');`;
    }).join('\n')}
</style>
